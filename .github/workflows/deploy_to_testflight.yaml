name: Deploy to TestFlight

on:
  push:
    branches:
      - app-release

jobs:
  build-and-deploy:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Flutter environment
      uses: subosito/flutter-action@v1
      with:
        flutter-version: '3.22.2'

    - name: Install dependencies
      run: flutter pub get

    - name: Build iOS app
      run: flutter build ios --release --no-codesign

    - name: Install Apple tools
      uses: apple-actions/setup-xcode@v1

    - name: Install Fastlane
      run: gem install fastlane

    - name: Build IPA with Fastlane Gym
      run: |
        fastlane gym --workspace "Runner.xcworkspace" --scheme "Runner" --clean --output_directory ./build --output_name "ClashKing"

    - name: Create API Key File
      run: |
        echo "${{ secrets.APPLE_API_KEY }}" > ./AuthKey.p8

    - name: List output directory contents
      run: ls -la ./build

    - name: Deploy to TestFlight
      run: |
        fastlane pilot upload \
          --api_key_path ./AuthKey.p8 \
          --app_identifier "com.clashking.clshkingapp" \
          --ipa "./build/ClashKing.ipa"
