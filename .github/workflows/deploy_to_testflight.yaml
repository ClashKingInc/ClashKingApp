name: Upload app to TestFlight

on:
  push:
    branches:
      - app-release

jobs:
  build-and-deploy:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Flutter environment
      uses: subosito/flutter-action@v1
      with:
        flutter-version: '3.22.2'

    - name: Install dependencies
      run: flutter pub get

    - name: Build iOS app
      run: flutter build ios --release --no-codesign

    - name: Install Fastlane
      run: sudo gem install fastlane

    - name: Build IPA with Fastlane Gym
      run: |
        fastlane gym --workspace "Runner.xcworkspace" --scheme "Runner" --clean --output_directory ./build --output_name "ClashKing"

    - name: Create API Key File
      run: |
        echo "${{ secrets.APPLE_API_PRIVATE_KEY }}" > ./AuthKey.p8

    - name: Upload to TestFlight
      run: |
        xcrun altool --upload-app --type ios --file ./build/ClashKing.ipa --apiKey ${{ secrets.APPLE_API_KEY_ID }} --apiIssuer ${{ secrets.APPLE_API_ISSUER_ID }} --apiPrivateKey ./AuthKey.p8

    - name: List output directory contents
      run: ls -la ./build
